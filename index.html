<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weighted Spin Wheel</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#151821; --ink:#e9ecf1; --muted:#a8b3c7; --accent:#6ee7ff; --shadow:rgba(0,0,0,.25)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%,#0f1320 0%,#0b0c10 60%);color:var(--ink);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    h1{font-size:22px;margin:0 0 12px}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:460px 1fr;gap:18px}
    .card{background:var(--panel);border-radius:16px;box-shadow:0 6px 24px var(--shadow);padding:16px}
    .wheel-wrap{display:grid;grid-template-rows:auto auto;gap:12px;justify-items:center}
    canvas{display:block;background:linear-gradient(180deg,#111522,#0b0c10);border-radius:50%;box-shadow:inset 0 0 0 2px rgba(255,255,255,.04),0 12px 40px var(--shadow)}
    .pointer{width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:22px solid var(--accent);filter:drop-shadow(0 6px 10px var(--shadow))}
    .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button, input, select, textarea{color:var(--ink);background:#1d2230;border:1px solid #2b3144;border-radius:10px;padding:10px 12px}
    button{cursor:pointer;font-weight:600;letter-spacing:.2px}
    button.primary{background:linear-gradient(180deg,#3aa0ff,#3bc7ff);color:#04121a;border:none}
    button.ghost{background:transparent;border:1px dashed #394057}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{width:100%;border-collapse:collapse}
    th,td{text-align:left;padding:8px}
    th{font-weight:600;color:var(--muted)}
    tr:nth-child(even){background:#151b28}
    td input{width:100%}
    .small{font-size:12px;color:var(--muted)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1a2233;color:var(--muted);font-size:12px}
    .stack{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{display:flex;justify-content:flex-end}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:1fr 1fr 1fr}
    textarea{min-height:84px;width:100%;resize:vertical}
    .result{font-size:18px;font-weight:700;letter-spacing:.3px}
    .badge{display:inline-block;border-radius:8px;background:#182033;padding:2px 6px;color:var(--accent);font-size:12px;margin-left:8px}
    .hr{height:1px;background:#252d40;margin:8px 0}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;background:#0f1523;border:1px solid #2b3144;border-radius:6px;padding:2px 6px;color:#b7c5df}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card wheel-wrap">
      <div class="stack" style="justify-content:space-between;width:100%">
        <h1>Weighted Spin Wheel <span id="sumBadge" class="badge"></span></h1>
        <div class="stack small">Press <span class="kbd">R</span> to spin</div>
      </div>
      <div class="pointer"></div>
      <canvas id="wheel" width="420" height="420" aria-label="spin wheel"></canvas>
      <div class="controls">
        <button id="spinBtn" class="primary">Spin</button>
        <button id="nudgeBtn">Nudge</button>
        <button id="seedBtn" class="ghost">Seed RNG</button>
        <button id="resetBtn" class="ghost">Reset</button>
        <label class="pill"><input id="snapCheck" type="checkbox" style="vertical-align:middle;margin-right:6px"> Snap to slice</label>
      </div>
      <div class="grid two" style="width:100%">
        <div class="card" style="background:#111521">
          <div class="small">Last result</div>
          <div class="result" id="lastResult">—</div>
          <div class="small" id="lastInfo"></div>
        </div>
        <div class="card" style="background:#111521">
          <div class="small">Conditional message</div>
          <div id="condMsg">—</div>
        </div>
      </div>
    </div>

    <div class="card grid">
      <div class="stack" style="justify-content:space-between">
        <h1>Outcomes & Weights</h1>
        <div class="stack">
          <button id="addRow">Add row</button>
          <button id="sortBtn">Sort by weight</button>
          <button id="shuffleBtn">Shuffle</button>
        </div>
      </div>

      <table>
        <thead>
          <tr><th style="width:44%">Label</th><th style="width:20%">Weight</th><th style="width:20%">Probability</th><th style="width:16%"></th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
      <div class="right small">Weights auto-normalised · <span id="sumText">Σ weights = 1.00</span></div>
      <div class="hr"></div>

      <div class="grid two">
        <div>
          <div class="small">Conditionality (one per line: <span class="kbd">Label => Message</span>)</div>
          <textarea id="conds" placeholder="Prize A => Play victory jingle\nTry Again => Reveal consolation tip"></textarea>
        </div>
        <div>
          <div class="small">State</div>
          <textarea id="state"></textarea>
          <div class="stack">
            <button id="saveBtn">Save</button>
            <button id="loadBtn">Load</button>
            <button id="exportBtn">Export JSON</button>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <button id="importBtn">Import JSON</button>
          </div>
        </div>
      </div>
      <div class="small">Tip: keep a few "Try again" thin slices to make the wheel feel lively without biasing big prizes too much.</div>
    </div>
  </div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // PRNG with seed (Mulberry32)
  function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
  let seededRng = null;

  // ---------- State ----------
  let items = [
    {label:"Prize A", weight:5},
    {label:"Prize B", weight:3},
    {label:"Try Again", weight:1},
    {label:"Mystery", weight:1}
  ];
  let totalWeight = 10;
  let spinning = false;
  let angle = 0; // radians
  let targetAngle = 0;
  let snapToSlice = false;

  // ---------- DOM refs ----------
  const rowsEl = $("#rows");
  const wheel = $("#wheel");
  const ctx = wheel.getContext("2d");
  const spinBtn = $("#spinBtn");
  const nudgeBtn = $("#nudgeBtn");
  const seedBtn = $("#seedBtn");
  const resetBtn = $("#resetBtn");
  const snapCheck = $("#snapCheck");
  const sumText = $("#sumText");
  const sumBadge = $("#sumBadge");
  const lastResult = $("#lastResult");
  const lastInfo = $("#lastInfo");
  const condMsg = $("#condMsg");
  const addRow = $("#addRow");
  const sortBtn = $("#sortBtn");
  const shuffleBtn = $("#shuffleBtn");
  const conds = $("#conds");
  const state = $("#state");
  const saveBtn = $("#saveBtn");
  const loadBtn = $("#loadBtn");
  const exportBtn = $("#exportBtn");
  const importBtn = $("#importBtn");
  const importFile = $("#importFile");

  // ---------- Rendering ----------
  function normalise(){
    totalWeight = items.reduce((a,b)=>a + Math.max(0, Number(b.weight)||0), 0);
  }
  function cumulative(){
    normalise();
    let s = 0; return items.map(it=>{const w = Math.max(0, Number(it.weight)||0); s += w/Math.max(1,totalWeight); return s});
  }
  function probAt(i){ normalise(); const w = Math.max(0, Number(items[i].weight)||0); return totalWeight? w/totalWeight : 0 }

  function drawWheel(){
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const size = 420; // CSS pixels
    if (wheel.width !== size*dpr){ wheel.width = size*dpr; wheel.height = size*dpr }
    wheel.style.width = size+"px"; wheel.style.height = size+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const r = size/2; const cx = r, cy = r;
    ctx.clearRect(0,0,size,size);

    const probs = items.map((_,i)=>probAt(i));
    let start = angle - Math.PI/2; // pointer at top

    // draw slices
    probs.forEach((p,i)=>{
      const sweep = p * Math.PI*2;
      if (sweep <= 0) return;
      const end = start + sweep;
      // colour: pseudo-random stable by label
      const hue = Math.abs(hash(items[i].label)) % 360;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r-4,start,end);
      ctx.closePath();
      ctx.fillStyle = `hsl(${hue} 65% 45% / .92)`;
      ctx.fill();
      // border
      ctx.lineWidth = 2; ctx.strokeStyle = "rgba(0,0,0,.35)"; ctx.stroke();

      // text
      const mid = (start+end)/2;
      ctx.save();
      ctx.translate(cx + Math.cos(mid)*(r*0.64), cy + Math.sin(mid)*(r*0.64));
      ctx.rotate(mid + Math.PI/2);
      ctx.fillStyle = "#f6f8ff";
      ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto";
      const label = items[i].label;
      truncateText(ctx,label,r*0.9);
      ctx.restore();

      start = end;
    });

    // center hub
    ctx.beginPath();
    ctx.arc(cx,cy,26,0,Math.PI*2);
    ctx.fillStyle = "#0e1422"; ctx.fill();
    ctx.lineWidth=2; ctx.strokeStyle="#2b3144"; ctx.stroke();

    // tick marks (subtle)
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);
    ctx.globalAlpha = .25;
    for(let i=0;i<probs.length;i++){
      const sweep = probs[i]*Math.PI*2;
      if (sweep<=0) continue;
      ctx.rotate(sweep);
      ctx.beginPath();
      ctx.moveTo(r-12,0); ctx.lineTo(r-4,0);
      ctx.strokeStyle = "#a8b3c7"; ctx.lineWidth = 1; ctx.stroke();
    }
    ctx.restore();
  }

  function truncateText(ctx,text,maxW){
    let t = text; while(ctx.measureText(t).width > maxW && t.length>2){ t = t.slice(0,-2) + "…" }
    ctx.fillText(t,-maxW/2,5);
  }
  function hash(s){ // tiny string hash for colour stability
    let h=0; for(let i=0;i<s.length;i++) h=Math.imul(31,h)+s.charCodeAt(i)|0; return h>>>0
  }

  function rebuildTable(){
    normalise();
    rowsEl.innerHTML = "";
    items.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${escapeHtml(it.label)}" data-k="label"></td>
        <td><input type="number" step="0.01" min="0" value="${Number(it.weight)}" data-k="weight"></td>
        <td class="small">${(probAt(idx)*100).toFixed(2)}%</td>
        <td><button data-act="del">Delete</button></td>`;
      rowsEl.appendChild(tr);
      tr.querySelector('[data-k="label"]').addEventListener('input', e=>{it.label=e.target.value; drawAll()});
      tr.querySelector('[data-k="weight"]').addEventListener('input', e=>{it.weight=parseFloat(e.target.value||0); drawAll()});
      tr.querySelector('[data-act="del"]').addEventListener('click', ()=>{items.splice(idx,1); drawAll()});
    });
    const sum = items.reduce((a,b)=>a+(+b.weight||0),0);
    sumText.textContent = `Σ weights = ${sum.toFixed(2)}`;
    sumBadge.textContent = `Total p = ${(sum>0?1:0).toFixed(0)}`;
  }

  function escapeHtml(s){return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c]))}

  function drawAll(){
    rebuildTable();
    drawWheel();
    saveState();
  }

  // ---------- Spin logic ----------
  function chooseIndex(){
    normalise();
    if(!totalWeight){ return 0 }
    const r = seededRng ? seededRng() : Math.random();
    let acc = 0;
    for(let i=0;i<items.length;i++){
      acc += probAt(i);
      if(r <= acc + 1e-12) return i;
    }
    return items.length-1; // guard for FP
  }

  function spin(){
    if (spinning || items.length===0) return;
    spinning = true; spinBtn.disabled = true; nudgeBtn.disabled = true;

    const idx = chooseIndex();
    const probs = items.map((_,i)=>probAt(i));
    const startAngles = []; let s=0; probs.forEach(p=>{startAngles.push(s); s += p*2*Math.PI});

    // We want the pointer (at -90°) to land in the middle of slice idx
    const sliceStart = startAngles[idx];
    const sliceEnd = sliceStart + probs[idx]*2*Math.PI;
    const mid = (sliceStart + sliceEnd) / 2;

    // Current angle is wheel rotation; pointer fixed at top. We spin forward K turns then align.
    const turns = 6 + Math.floor(Math.random()*4); // 6-9 turns
    const current = angle % (2*Math.PI);
    const desiredWheelAngle = (Math.PI/2 - mid); // so mid goes to top
    let delta = desiredWheelAngle - current + turns*2*Math.PI;

    // option: snap to exact mid vs. add a tiny jitter inside slice
    if (!snapToSlice){
      const jitter = (probs[idx]*2*Math.PI) * ( (seededRng?seededRng():Math.random())*0.8 - 0.4 );
      delta += jitter;
    }

    targetAngle = angle + delta;

    const duration = 2800 + Math.min(2200, probs.length*120); // ms
    const t0 = performance.now();
    const start = angle;

    function easeOutCubic(t){return 1 - Math.pow(1-t,3)}
    (function anim(now){
      const u = Math.min(1, (now - t0)/duration);
      const eased = easeOutCubic(u);
      angle = start + (targetAngle - start) * eased;
      drawWheel();
      if (u < 1) requestAnimationFrame(anim); else { finish(idx) }
    })(t0);
  }

  function finish(idx){
    spinning = false; spinBtn.disabled = false; nudgeBtn.disabled = false;
    const p = probAt(idx);
    lastResult.textContent = items[idx].label || "—";
    lastInfo.textContent = `p ≈ ${(p*100).toFixed(2)}%`;
    runCondition(items[idx].label);
    saveState();
  }

  function nudge(){ angle += 0.15; drawWheel() }

  // ---------- Conditionality ----------
  function parseConds(){
    const lines = conds.value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const map = new Map();
    for (const ln of lines){
      const m = ln.split(/=>/);
      if (m.length>=2){ const k=m[0].trim(); const v=m.slice(1).join('=>').trim(); if(k) map.set(k,v) }
    }
    return map;
  }
  function runCondition(label){
    const map = parseConds();
    condMsg.textContent = map.get(label) || '—';
  }

  // ---------- Persistence ----------
  function saveState(){
    const s = JSON.stringify({items, snapToSlice, conds: conds.value});
    localStorage.setItem('weighted-wheel-state', s);
    state.value = s;
  }
  function loadState(text){
    try{
      const s = text || localStorage.getItem('weighted-wheel-state');
      if(!s) return;
      const obj = JSON.parse(s);
      if (Array.isArray(obj.items)) items = obj.items.map(o=>({label:String(o.label||''), weight:Number(o.weight)||0}));
      snapToSlice = !!obj.snapToSlice; snapCheck.checked = snapToSlice;
      conds.value = String(obj.conds||'');
      drawAll();
    }catch(e){ alert('Could not load state: '+e.message) }
  }

  // ---------- Events ----------
  spinBtn.addEventListener('click', spin);
  nudgeBtn.addEventListener('click', nudge);
  seedBtn.addEventListener('click', ()=>{
    const s = prompt('Enter an integer seed (blank to clear):','12345');
    if (s===null) return;
    const n = parseInt(s,10);
    seededRng = Number.isFinite(n) ? mulberry32(n>>>0) : null;
    seedBtn.textContent = seededRng? 'Seeded' : 'Seed RNG';
  });
  resetBtn.addEventListener('click', ()=>{ items=[{label:"Prize A",weight:5},{label:"Prize B",weight:3},{label:"Try Again",weight:1},{label:"Mystery",weight:1}]; angle=0; seededRng=null; conds.value=''; snapCheck.checked=false; snapToSlice=false; drawAll(); });
  snapCheck.addEventListener('change', e=>{snapToSlice = e.target.checked; saveState()});
  addRow.addEventListener('click', ()=>{ items.push({label:"New",weight:1}); drawAll()});
  sortBtn.addEventListener('click', ()=>{ items.sort((a,b)=>b.weight-a.weight); drawAll()});
  shuffleBtn.addEventListener('click', ()=>{ for(let i=items.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [items[i],items[j]]=[items[j],items[i]] } drawAll()});

  saveBtn.addEventListener('click', saveState);
  loadBtn.addEventListener('click', ()=> loadState());
  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([state.value||JSON.stringify({items, snapToSlice, conds: conds.value})], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'weighted-wheel.json';
    a.click();
  });
  importBtn.addEventListener('click', ()=> importFile.click());
  importFile.addEventListener('change', e=>{
    const file = e.target.files?.[0]; if(!file) return;
    file.text().then(txt=> loadState(txt));
  });

  document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='r'){ e.preventDefault(); spin() }});

  // ---------- Boot ----------
  loadState();
  drawAll();
})();
</script>
</body>
</html>
